<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | Ligue Pro Des Académies</title>
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
    <link rel="stylesheet" href="style.css">
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="data.js"></script>
    <script>
        // AUTHENTICATION LOGIC
        const ADMIN_PWD_HASH = "LiguePro2026"; // Simple string for now

        function checkAuth() {
            if (sessionStorage.getItem('lpa_authenticated') === 'true') {
                document.body.classList.add('authenticated');
                const overlay = document.getElementById('admin-login-overlay');
                if (overlay) overlay.style.display = 'none';
            }
        }

        function login() {
            const pwd = document.getElementById('admin-pwd').value;
            if (pwd === ADMIN_PWD_HASH) {
                sessionStorage.setItem('lpa_authenticated', 'true');
                location.reload();
            } else {
                alert("Mot de passe incorrect.");
            }
        }

        document.addEventListener('DOMContentLoaded', checkAuth);
    </script>
</head>

<body class="admin_dashboard">
    <!-- ADMIN LOGIN OVERLAY -->
    <div id="admin-login-overlay">
        <div class="login-box">
            <img src="images/logo_ligue.png" alt="Logo" class="login-logo">
            <h2>Accès Restreint</h2>
            <p>Veuillez entrer le mot de passe administrateur.</p>

            <div class="login-input-group">
                <label>Mot de passe</label>
                <input type="password" id="admin-pwd" placeholder="••••••••"
                    onkeypress="if(event.key==='Enter') login()">
            </div>

            <button class="btn-primary" onclick="login()">
                <i class='bx bx-lock-open-alt'></i> Se connecter
            </button>
        </div>
    </div>

    <!-- NAVIGATION -->
    <nav id="navbar" class="scrolled">
        <a href="index.html" class="nav_logo">
            <img src="images/logo_ligue.png" alt="Ligue Pro Des Académies">
        </a>

        <div class="nav_menu" id="nav-menu">
            <i class='bx bx-x menu_close' id="menu-close"></i>
            <ul>
                <li><a href="index.html">Accueil</a></li>
                <li><a href="u17.html">U17</a></li>
                <li><a href="u19.html">U19</a></li>
                <li><a href="admin.html" class="active">Admin</a></li>
            </ul>
        </div>

        <div class="menu_toggle" id="menu-toggle">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </nav>

    <div class="admin_container">
        <div class="admin_header">
            <div>
                <h1>Dashboard <span class="highlight-yellow">Admin</span></h1>
                <p>Gestion avancée des Catégories et Tirages</p>
            </div>
            <div class="admin_user">
                <button onclick="resetAllData()" title="Réinitialiser"
                    style="background: none; border: none; cursor: pointer; color: var(--jaune-or);">
                    <i class='bx bx-refresh' style="font-size: 30px;"></i>
                </button>
            </div>
        </div>

        <div class="admin_nav">
            <button class="nav_btn admin_nav_btn active" onclick="showTab(event, 'categories')">Catégories</button>
            <button class="nav_btn admin_nav_btn" onclick="showTab(event, 'teams')">Équipes</button>
            <button class="nav_btn admin_nav_btn" onclick="showTab(event, 'matches')">Matchs</button>
            <button class="nav_btn admin_nav_btn" onclick="showTab(event, 'news')">Actualités</button>
            <button class="nav_btn admin_nav_btn" onclick="showTab(event, 'stadiums')">Stades</button>
            <button class="nav_btn admin_nav_btn" onclick="showTab(event, 'draw')">Tirage</button>
            <button class="nav_btn admin_nav_btn" onclick="showTab(event, 'data_mgmt')">Données</button>
        </div>

        <!-- CATEGORIES TAB -->
        <div id="categories" class="admin_tab_content">
            <div class="admin_content_card">
                <h2>Créer une <span class="highlight">Catégorie</span></h2>
                <form class="admin_form" id="catForm">
                    <div class="form_group">
                        <label>Nom de la Catégorie</label>
                        <input type="text" id="catName" placeholder="Ex: U17 Poule A" required>
                    </div>
                    <div class="form_group">
                        <label>Type de Championnat</label>
                        <select id="catType">
                            <option value="poule">Poule (dans un championnat à plusieurs groupes)</option>
                            <option value="unique">Poule Unique / Championnat Direct</option>
                        </select>
                    </div>
                    <div class="form_group" style="justify-content: flex-end;">
                        <button type="submit" class="btn-primary">Créer Catégorie</button>
                    </div>
                </form>

                <div class="classement_table admin_table">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Nom</th>
                                    <th>Type</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="catTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- TEAMS TAB -->
        <div id="teams" class="admin_tab_content" style="display: none;">
            <div class="admin_content_card">
                <h2>Ajouter une <span class="highlight">Équipe</span></h2>
                <form class="admin_form" id="teamForm">
                    <div class="form_group">
                        <label>Nom de l'Équipe</label>
                        <input type="text" id="teamName" required>
                    </div>
                    <div class="form_group">
                        <label>Logo de l'Équipe</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="file" id="teamLogoFile" accept="image/*" onchange="previewLogo(this)"
                                style="display: none;">
                            <label for="teamLogoFile" class="btn-outline"
                                style="cursor: pointer; margin: 0; padding: 10px 20px;">
                                <i class='bx bx-upload'></i> Choisir Image
                            </label>
                            <div id="logoPreview"
                                style="width: 50px; height: 50px; border-radius: 50%; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--vert-principal);">
                                <i class='bx bx-image' style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form_group">
                        <label>Assigner au Championnat</label>
                        <select id="teamCat"></select>
                    </div>
                    <div class="form_group" style="justify-content: flex-end;">
                        <button type="submit" class="btn-primary">Ajouter Équipe</button>
                    </div>
                </form>

                <div class="classement_table admin_table">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Logo</th>
                                    <th>Nom</th>
                                    <th>Championnat</th>
                                    <th>Points</th>
                                    <th>Diff</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="teamTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- MATCHS TAB -->
        <div id="matches" class="admin_tab_content" style="display: none;">
            <div class="admin_content_card">
                <h2>Programmer un <span class="highlight">Match</span></h2>
                <form class="admin_form" id="matchForm">
                    <div class="form_group">
                        <label>Catégorie</label>
                        <select id="matchCatSelect" onchange="updateMatchTeams()"></select>
                    </div>
                    <div class="form_group">
                        <label>Date</label>
                        <input type="date" id="matchDate">
                    </div>
                    <div class="form_group">
                        <label>Heure</label>
                        <input type="time" id="matchTime">
                    </div>
                    <div class="form_group">
                        <label>Affiche (Équipe 1 vs Équipe 2)</label>
                        <div style="display: flex; gap: 10px; align-items: center; width: 100%;">
                            <select id="matchTeam1" required style="flex: 1;"></select>
                            <span style="font-weight: bold; opacity: 0.5;">VS</span>
                            <select id="matchTeam2" required style="flex: 1;"></select>
                        </div>
                    </div>
                    <div class="form_group">
                        <label>Lieu</label>
                        <input type="text" id="matchVenue" required>
                    </div>
                    <div class="form_group" style="justify-content: flex-end;">
                        <button type="submit" class="btn-primary">Programmer</button>
                    </div>
                </form>
                <div class="classement_table admin_table">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Catégorie</th>
                                    <th>Match</th>
                                    <th>Lieu</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="matchTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- NEWS TAB -->
        <div id="news" class="admin_tab_content" style="display: none;">
            <div class="admin_content_card">
                <h2>Gérer les <span class="highlight">Actualités</span></h2>
                <form class="admin_form" id="newsForm">
                    <div class="form_group">
                        <label>Titre de l'article</label>
                        <input type="text" id="newsTitle" required placeholder="Ex: Grande finale ce weekend">
                    </div>
                    <div class="form_group">
                        <label>Résumé court</label>
                        <textarea id="newsSummary" required
                            style="width: 100%; min-height: 80px; background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--vert-principal); border-radius: 10px; padding: 15px;"></textarea>
                    </div>
                    <div class="form_group">
                        <label>Contenu complet</label>
                        <textarea id="newsContent" required
                            style="width: 100%; min-height: 150px; background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--vert-principal); border-radius: 10px; padding: 15px;"></textarea>
                    </div>
                    <div class="form_group">
                        <label>Photo de l'Actualité</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="file" id="newsLogoFile" accept="image/*" onchange="previewNewsLogo(this)"
                                style="display: none;">
                            <label for="newsLogoFile" class="btn-outline"
                                style="cursor: pointer; margin: 0; padding: 10px 20px;">
                                <i class='bx bx-upload'></i> Choisir Image
                            </label>
                            <div id="newsLogoPreview"
                                style="width: 80px; height: 80px; border-radius: 10px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--vert-principal);">
                                <i class='bx bx-image' style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form_group" style="justify-content: flex-end;">
                        <button type="submit" class="btn-primary">Publier l'article</button>
                    </div>
                </form>

                <div class="classement_table admin_table">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Titre</th>
                                    <th>Résumé</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="newsTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- DRAW TAB -->
        <div id="draw" class="admin_tab_content" style="display: none;">
            <div class="admin_content_card">
                <h2>Tirages au Sort <span class="highlight">Indépendants</span></h2>
                <p>Gérez le tirage aléatoire du calendrier ou des compositions par catégorie.</p>
            </div>
        </div>

        <!-- STADIUMS TAB -->
        <div id="stadiums" class="admin_tab_content" style="display: none;">
            <div class="admin_content_card">
                <h2>Gérer les <span class="highlight">Stades</span></h2>

                <!-- Add Stadium Form -->
                <form class="admin_form" id="stadiumForm">
                    <div class="form_group">
                        <label>Nom du Stade</label>
                        <input type="text" id="stadiumName" required placeholder="Ex: Stade Caroline Faye">
                    </div>
                    <div class="form_group">
                        <label>Lieu / Ville</label>
                        <input type="text" id="stadiumLocation" required placeholder="Ex: Mbour">
                    </div>
                    <div class="form_group">
                        <label>Contact Gérant</label>
                        <input type="text" id="stadiumContact" placeholder="Tél ou Email">
                    </div>
                    <div class="form_group">
                        <label>Photo</label>
                        <div style="display: flex; align-items: center; gap: 15px;">
                            <input type="file" id="stadiumImageFile" accept="image/*"
                                onchange="previewStadiumImage(this)" style="display: none;">
                            <label for="stadiumImageFile" class="btn-outline"
                                style="cursor: pointer; margin: 0; padding: 10px 20px;">
                                <i class='bx bx-upload'></i> Choisir Image
                            </label>
                            <div id="stadiumImagePreview"
                                style="width: 80px; height: 80px; border-radius: 10px; background: rgba(255,255,255,0.05); display: flex; align-items: center; justify-content: center; overflow: hidden; border: 1px solid var(--vert-principal);">
                                <i class='bx bx-image' style="opacity: 0.3;"></i>
                            </div>
                        </div>
                    </div>
                    <div class="form_group" style="justify-content: flex-end;">
                        <button type="submit" class="btn-primary">Ajouter Stade</button>
                    </div>
                </form>

                <!-- Stadiums List -->
                <div class="classement_table admin_table">
                    <div class="table-responsive">
                        <table>
                            <thead>
                                <tr>
                                    <th>Image</th>
                                    <th>Nom</th>
                                    <th>Lieu</th>
                                    <th>Contact</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="stadiumTableBody"></tbody>
                        </table>
                    </div>
                </div>

                <hr style="margin: 40px 0; border: 0; border-top: 1px solid rgba(255,255,255,0.1);">

                <!-- Slots Management Section -->
                <h3>Gestion des <span class="highlight">Créneaux</span></h3>
                <div style="background: rgba(255,255,255,0.05); padding: 20px; border-radius: 10px; margin-top: 20px;">
                    <div class="form_group">
                        <label>Choisir un Stade pour gérer ses créneaux</label>
                        <select id="slotStadiumSelect" onchange="renderStadiumSlots()"></select>
                    </div>

                    <form id="slotForm"
                        style="display: flex; gap: 10px; align-items: flex-end; flex-wrap: wrap; margin-top: 20px; border-top: 1px solid rgba(255,255,255,0.1); padding-top: 20px;">
                        <div class="form_group">
                            <label>Date</label>
                            <input type="date" id="slotDate" required>
                        </div>
                        <div class="form_group">
                            <label>Début</label>
                            <input type="time" id="slotStart" required>
                        </div>
                        <div class="form_group">
                            <label>Fin</label>
                            <input type="time" id="slotEnd" required>
                        </div>
                        <div class="form_group">
                            <label>Prix (FCFA)</label>
                            <input type="number" id="slotPrice" placeholder="50000" required>
                        </div>
                        <div class="form_group">
                            <button type="submit" class="btn-primary"><i class='bx bx-plus'></i> Ajout</button>
                        </div>
                    </form>

                    <div class="classement_table admin_table" style="margin-top: 20px;">
                        <table style="font-size: 0.9rem;">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Heure</th>
                                    <th>Prix</th>
                                    <th>Statut</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="slotTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- DATA MANAGEMENT TAB -->
    <div id="data_mgmt" class="admin_tab_content" style="display: none;">
        <div class="admin_content_card">
            <h2>Gestion des <span class="highlight">Données</span></h2>
            <p>Exportez vos données locales pour les sauvegarder ou les synchroniser avec Vercel.</p>

            <div style="display: flex; gap: 20px; margin-top: 30px; flex-wrap: wrap;">
                <button class="btn-primary" onclick="exportData()">
                    <i class='bx bx-download'></i> Exporter les données (.json)
                </button>

                <div style="position: relative;">
                    <input type="file" id="importFile" accept=".json" onchange="importData(this)"
                        style="display: none;">
                    <label for="importFile" class="btn-outline"
                        style="cursor: pointer; margin: 0; display: inline-flex; align-items: center; gap: 10px;">
                        <i class='bx bx-upload'></i> Importer un fichier (.json)
                    </label>
                </div>
            </div>

            <div
                style="margin-top: 40px; padding: 20px; background: rgba(5, 150, 105, 0.1); border-left: 4px solid var(--vert-principal); border-radius: 4px;">
                <h4 style="color: var(--vert-principal); margin-bottom: 10px;"><i class='bx bx-cloud'></i> Configuration
                    Supabase (Auto-Sync)</h4>
                <p style="font-size: 0.85rem; margin-bottom: 15px; opacity: 0.8;">Connectez votre base de données pour
                    que Vercel se mette à jour automatiquement sans modification de code.</p>

                <div class="admin_form" style="display: flex; flex-direction: column; gap: 10px; max-width: 500px;">
                    <div class="form_group">
                        <label style="font-size: 0.8rem;">Supabase URL</label>
                        <input type="text" id="supabaseUrl" placeholder="https://xyz.supabase.co"
                            style="font-size: 0.9rem;">
                    </div>
                    <div class="form_group">
                        <label style="font-size: 0.8rem;">Supabase Anon Key</label>
                        <input type="password" id="supabaseKey" placeholder="votre-cle-api-anon"
                            style="font-size: 0.9rem;">
                    </div>
                    <button class="btn-primary" onclick="saveSupabaseConfig()"
                        style="width: fit-content; margin-top: 5px;">
                        Activer la Sync Cloud
                    </button>
                    <button class="btn-outline" onclick="testSupabaseDirect()"
                        style="width: fit-content; margin-top: 5px; border-color: #6366f1; color: #6366f1;">
                        <i class='bx bx-bug'></i> Tester la Connexion Directe
                    </button>
                    <p id="supabaseStatus" style="font-size: 0.75rem; color: var(--jaune-or); margin-top: 5px;"></p>
                </div>
            </div>

            <div
                style="margin-top: 20px; padding: 20px; background: rgba(255,193,7,0.1); border-left: 4px solid var(--jaune-or); border-radius: 4px;">
                <h4 style="color: var(--jaune-or); margin-bottom: 10px;"><i class='bx bx-info-circle'></i> Aide à la
                    configuration</h4>
                <ol style="margin-left: 20px; line-height: 1.6; font-size: 0.9rem;">
                    <li>Créez un projet sur <a href="https://supabase.com" target="_blank"
                            style="color: var(--jaune-or);">Supabase</a>.</li>
                    <li>Dans votre dashboard Supabase, allez dans <strong>Project Settings > API</strong>.</li>
                    <li>Copiez le <strong>Project URL</strong> et la <strong>anon public Key</strong> ci-dessus.</li>
                    <li><strong>IMPORTANT:</strong> Dans l'onglet "SQL Editor" de Supabase, créez une table nommée
                        <code>app_state</code> avec deux colonnes : <code>id</code> (text, primary key) et
                        <code>config_data</code> (jsonb).
                    </li>
                </ol>
            </div>
        </div>
    </div>
    </div>

    <script>
        // Tab management
        function showTab(e, tabId) {
            document.querySelectorAll('.admin_tab_content').forEach(tab => tab.style.display = 'none');
            document.querySelectorAll('.nav_btn').forEach(btn => btn.classList.remove('active'));

            const targetTab = document.getElementById(tabId);
            if (targetTab) targetTab.style.display = 'block';

            if (e && e.currentTarget) {
                e.currentTarget.classList.add('active');
            }

            if (tabId === 'categories') renderCategories();
            if (tabId === 'teams') renderTeams();
            if (tabId === 'matches') renderMatches();
            if (tabId === 'news') renderNews();
            if (tabId === 'stadiums') renderStadiums();
            if (tabId === 'draw') renderDraws();
            if (tabId === 'data_mgmt') { /* No specific render needed for now */ }
        }

        // --- STADIUMS ---
        function renderStadiums() {
            const data = getData();
            const tbody = document.getElementById('stadiumTableBody');
            tbody.innerHTML = '';

            // Populate select for slots
            const slotSelect = document.getElementById('slotStadiumSelect');
            const currentSel = slotSelect.value;
            slotSelect.innerHTML = '<option value="">-- Choisir un stade --</option>';

            data.stadiums.forEach(s => {
                // Table Row
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${s.image}" style="width: 40px; height: 40px; border-radius: 4px; object-fit: cover;"></td>
                    <td><strong>${s.name}</strong></td>
                    <td>${s.location}</td>
                    <td>${s.contact || '-'}</td>
                    <td>
                        <button class="btn_action btn_edit" onclick="handleEditStadium(${s.id})"><i class='bx bx-edit'></i></button>
                        <button class="btn_action btn_delete" onclick="handleDeleteStadium(${s.id})"><i class='bx bx-trash'></i></button>
                    </td>
                `;
                tbody.appendChild(tr);

                // Select Option
                const opt = document.createElement('option');
                opt.value = s.id;
                opt.textContent = s.name;
                slotSelect.appendChild(opt);
            });

            if (currentSel) slotSelect.value = currentSel;
        }

        let editingStadiumId = null;
        let currentStadiumImageBase64 = 'images/stadium_default.jpg';

        function previewStadiumImage(input) {
            const preview = document.getElementById('stadiumImagePreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    currentStadiumImageBase64 = e.target.result;
                    preview.innerHTML = `<img src="${currentStadiumImageBase64}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleEditStadium(id) {
            const data = getData();
            const s = data.stadiums.find(item => item.id === id);
            if (!s) return;

            editingStadiumId = id;
            document.getElementById('stadiumName').value = s.name;
            document.getElementById('stadiumLocation').value = s.location;
            document.getElementById('stadiumContact').value = s.contact;

            currentStadiumImageBase64 = s.image || 'images/stadium_default.jpg';
            document.getElementById('stadiumImagePreview').innerHTML = `<img src="${currentStadiumImageBase64}" style="width: 100%; height: 100%; object-fit: cover;">`;

            document.querySelector('#stadiumForm .btn-primary').innerText = "Mettre à jour";
            document.getElementById('stadiumForm').scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('stadiumForm').onsubmit = function (e) {
            e.preventDefault();
            const name = document.getElementById('stadiumName').value;
            const location = document.getElementById('stadiumLocation').value;
            const contact = document.getElementById('stadiumContact').value;
            const image = currentStadiumImageBase64;

            if (editingStadiumId) {
                updateStadium(editingStadiumId, { name, location, contact, image });
                editingStadiumId = null;
                document.querySelector('#stadiumForm .btn-primary').innerText = "Ajouter Stade";
            } else {
                addStadium(name, location, contact, image);
            }

            this.reset();
            currentStadiumImageBase64 = 'images/stadium_default.jpg';
            document.getElementById('stadiumImagePreview').innerHTML = `<i class='bx bx-image' style="opacity: 0.3;"></i>`;
            renderStadiums();
        };

        function handleDeleteStadium(id) {
            if (confirm('Supprimer ce stade et tous ses créneaux ?')) {
                deleteStadium(id);
                renderStadiums();
            }
        }

        // --- STADIUM SLOTS ---
        function renderStadiumSlots() {
            const stadiumId = document.getElementById('slotStadiumSelect').value;
            const tbody = document.getElementById('slotTableBody');
            tbody.innerHTML = '';

            if (!stadiumId) return;

            const slots = getStadiumSlots(stadiumId);
            slots.forEach(s => {
                const tr = document.createElement('tr');
                const isBooked = s.status === 'booked';
                tr.innerHTML = `
                    <td>${new Date(s.date).toLocaleDateString()}</td>
                    <td>${s.start} - ${s.end}</td>
                    <td>${s.price} FCFA</td>
                    <td><span style="color: ${isBooked ? 'var(--jaune-or)' : '#10b981'}; font-weight: bold;">${isBooked ? 'RÉSERVÉ' : 'LIBRE'}</span></td>
                    <td>
                        <button class="btn_action btn_delete" onclick="handleDeleteSlot(${s.id})"><i class='bx bx-trash'></i></button>
                        ${!isBooked ? `<button class="btn_action" onclick="updateSlotStatus(${s.id}, 'booked'); renderStadiumSlots();" style="border: 1px solid var(--jaune-or); color: var(--jaune-or);" title="Marquer réservé"><i class='bx bx-check'></i></button>` :
                        `<button class="btn_action" onclick="updateSlotStatus(${s.id}, 'available'); renderStadiumSlots();" style="border: 1px solid #10b981; color: #10b981;" title="Marquer libre"><i class='bx bx-undo'></i></button>`}
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        document.getElementById('slotForm').onsubmit = function (e) {
            e.preventDefault();
            const stadiumId = document.getElementById('slotStadiumSelect').value;
            if (!stadiumId) {
                alert("Veuillez d'abord sélectionner un stade.");
                return;
            }

            const date = document.getElementById('slotDate').value;
            const start = document.getElementById('slotStart').value;
            const end = document.getElementById('slotEnd').value;
            const price = document.getElementById('slotPrice').value;

            addSlot(stadiumId, date, start, end, price);
            // Don't reset everything, maybe just times?
            // this.reset(); 
            renderStadiumSlots();
        };

        function handleDeleteSlot(id) {
            if (confirm('Supprimer ce créneau ?')) {
                deleteSlot(id);
                renderStadiumSlots();
            }
        }

        // --- CATEGORIES ---
        function renderCategories() {
            const data = getData();
            const tbody = document.getElementById('catTableBody');
            tbody.innerHTML = '';
            data.categories.forEach(c => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${c.id}</td>
                    <td><strong>${c.name}</strong></td>
                    <td>${c.type}</td>
                    <td>
                        <button class="btn_action btn_edit" onclick="handleEditCat('${c.id}', '${c.name}', '${c.type}')"><i class='bx bx-edit'></i></button>
                        <button class="btn_action btn_delete" onclick="handleDeleteCat('${c.id}')"><i class='bx bx-trash'></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        let editingCatId = null;

        function handleEditCat(id, name, type) {
            editingCatId = id;
            document.getElementById('catName').value = name;
            document.getElementById('catType').value = type;
            document.querySelector('#catForm .btn-primary').innerText = "Mettre à jour";
            // Scroll to form
            document.getElementById('catForm').scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('catForm').onsubmit = function (e) {
            e.preventDefault();
            const name = document.getElementById('catName').value;
            const type = document.getElementById('catType').value;

            if (editingCatId) {
                updateCategory(editingCatId, { name, type });
                editingCatId = null;
                document.querySelector('#catForm .btn-primary').innerText = "Créer Catégorie";
            } else {
                addCategory(name, type);
            }
            this.reset();
            renderCategories();
        };

        function handleDeleteCat(id) {
            if (confirm('Supprimer cette catégorie et TOUTES ses équipes ?')) {
                deleteCategory(id);
                renderCategories();
            }
        }

        // --- TEAMS ---
        function renderTeams() {
            const data = getData();
            const select = document.getElementById('teamCat');
            select.innerHTML = '';
            data.categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });

            const tbody = document.getElementById('teamTableBody');
            tbody.innerHTML = '';
            data.teams.forEach(t => {
                const cat = data.categories.find(c => c.id === t.categoryId);
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td><img src="${t.logo || 'images/logo_ligue.png'}" style="width: 30px; height: 30px; border-radius: 50%; object-fit: contain;"></td>
                    <td><strong>${t.name}</strong></td>
                    <td>${cat ? cat.name : 'Inconnu'}</td>
                    <td><input type="number" value="${t.points}" onchange="handleUpdatePoints(${t.id}, this.value)" style="width: 50px; background: transparent; color: white; border: 1px solid var(--vert-principal); text-align: center;"></td>
                    <td><strong>${t.diff > 0 ? '+' + t.diff : t.diff}</strong></td>
                    <td>
                        <button class="btn_action btn_edit" onclick="handleEditTeam(${t.id})"><i class='bx bx-edit'></i></button>
                        <button class="btn_action btn_delete" onclick="handleDeleteTeam(${t.id})"><i class='bx bx-trash'></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        let editingTeamId = null;

        function handleEditTeam(id) {
            const data = getData();
            const team = data.teams.find(t => t.id === id);
            if (!team) return;

            editingTeamId = id;
            document.getElementById('teamName').value = team.name;
            document.getElementById('teamCat').value = team.categoryId;
            currentLogoBase64 = team.logo || 'images/logo_ligue.png';
            document.getElementById('logoPreview').innerHTML = `<img src="${currentLogoBase64}" style="width: 100%; height: 100%; object-fit: contain;">`;
            document.querySelector('#teamForm .btn-primary').innerText = "Mettre à jour";
            document.getElementById('teamForm').scrollIntoView({ behavior: 'smooth' });
        }

        let currentLogoBase64 = 'images/logo_ligue.png';

        function previewLogo(input) {
            const preview = document.getElementById('logoPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    currentLogoBase64 = e.target.result;
                    preview.innerHTML = `<img src="${currentLogoBase64}" style="width: 100%; height: 100%; object-fit: contain;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        document.getElementById('teamForm').onsubmit = function (e) {
            e.preventDefault();
            const name = document.getElementById('teamName').value;
            const catId = document.getElementById('teamCat').value;
            const logo = currentLogoBase64;

            if (editingTeamId) {
                updateTeam(editingTeamId, { name, categoryId: catId, logo });
                editingTeamId = null;
                document.querySelector('#teamForm .btn-primary').innerText = "Ajouter Équipe";
            } else {
                addTeam(name, catId, logo);
            }

            // Reset
            this.reset();
            currentLogoBase64 = 'images/logo_ligue.png';
            document.getElementById('logoPreview').innerHTML = `<i class='bx bx-image' style="opacity: 0.3;"></i>`;
            renderTeams();
        };

        function handleUpdatePoints(id, val) {
            updateTeam(id, { points: parseInt(val) });
        }

        function handleDeleteTeam(id) {
            if (confirm('Supprimer cette équipe ?')) {
                deleteTeam(id);
                renderTeams();
            }
        }

        // --- MATCHES ---
        function renderMatches() {
            const data = getData();
            const select = document.getElementById('matchCatSelect');
            select.innerHTML = '';
            data.categories.forEach(c => {
                const opt = document.createElement('option');
                opt.value = c.id;
                opt.textContent = c.name;
                select.appendChild(opt);
            });

            const tbody = document.getElementById('matchTableBody');
            tbody.innerHTML = '';
            data.matches.sort((a, b) => {
                if (!a.date) return 1;
                if (!b.date) return -1;
                return new Date(a.date) - new Date(b.date);
            }).forEach(m => {
                const cat = data.categories.find(c => c.id === m.categoryId);
                const displayDate = m.date ? m.date : 'À définir';
                const displayTime = m.time ? m.time : '';
                const isPlayed = m.status === 'played';

                const teams = m.teams.split(' vs ');
                const t1 = data.teams.find(t => t.name === teams[0]);
                const t2 = data.teams.find(t => t.name === teams[1]);

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${displayDate} ${displayTime}</td>
                    <td>${cat ? cat.name : 'Inconnu'}</td>
                    <td>
                        <div style="display: flex; flex-direction: column; gap: 5px;">
                            <div style="display: flex; align-items: center; gap: 10px; font-weight: bold;">
                                <img src="${t1 ? t1.logo : 'images/logo_ligue.png'}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: contain;">
                                <span>${teams[0] || 'TBD'}</span>
                                <span style="opacity: 0.5;">vs</span>
                                <span>${teams[1] || 'TBD'}</span>
                                <img src="${t2 ? t2.logo : 'images/logo_ligue.png'}" style="width: 20px; height: 20px; border-radius: 50%; object-fit: contain;">
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px; margin-top: 5px;">
                                <input type="number" value="${m.score1}" onchange="handleScoreUpdate(${m.id}, 'score1', this.value)" 
                                    style="width: 40px; background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--vert-principal); text-align: center; border-radius: 4px;">
                                <span style="opacity: 0.5;">-</span>
                                <input type="number" value="${m.score2}" onchange="handleScoreUpdate(${m.id}, 'score2', this.value)" 
                                    style="width: 40px; background: rgba(255,255,255,0.05); color: white; border: 1px solid var(--vert-principal); text-align: center; border-radius: 4px;">
                                <button class="btn_action ${isPlayed ? 'btn_edit' : 'btn_outline'}" 
                                    onclick="handleToggleStatus(${m.id}, '${isPlayed ? 'upcoming' : 'played'}')"
                                    title="${isPlayed ? 'Remettre en à venir' : 'Valider le score'}"
                                    style="padding: 2px 8px; font-size: 10px; height: auto; width: auto; border: 1px solid ${isPlayed ? 'var(--jaune-or)' : 'var(--vert-principal)'};">
                                    ${isPlayed ? 'TERMINE' : 'VALIDER'}
                                </button>
                            </div>
                        </div>
                    </td>
                    <td>${m.venue}</td>
                    <td>
                        <button class="btn_action btn_edit" onclick="handleEditMatch(${m.id})"><i class='bx bx-edit'></i></button>
                        <button class="btn_action btn_delete" onclick="handleDeleteMatch(${m.id})"><i class='bx bx-trash'></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        let editingMatchId = null;

        function handleEditMatch(id) {
            const data = getData();
            const m = data.matches.find(match => match.id === id);
            if (!m) return;

            editingMatchId = id;
            document.getElementById('matchCatSelect').value = m.categoryId;
            updateMatchTeams(); // Important to fill the team selects

            const teams = m.teams.split(' vs ');
            document.getElementById('matchTeam1').value = teams[0] || '';
            document.getElementById('matchTeam2').value = teams[1] || '';
            document.getElementById('matchDate').value = m.date || '';
            document.getElementById('matchTime').value = m.time || '';
            document.getElementById('matchVenue').value = m.venue || '';

            document.querySelector('#matchForm .btn-primary').innerText = "Mettre à jour";
            document.getElementById('matchForm').scrollIntoView({ behavior: 'smooth' });
        }

        function handleScoreUpdate(id, field, val) {
            const updates = {};
            updates[field] = parseInt(val) || 0;
            updateMatch(id, updates);
        }

        function handleToggleStatus(id, newStatus) {
            updateMatch(id, { status: newStatus });
            renderMatches();
            if (newStatus === 'played') {
                alert("Score validé ! Le classement a été mis à jour automatiquement.");
            }
        }

        function updateMatchTeams() {
            const data = getData();
            const catId = document.getElementById('matchCatSelect').value;
            const teams = data.teams.filter(t => t.categoryId === catId);

            const sel1 = document.getElementById('matchTeam1');
            const sel2 = document.getElementById('matchTeam2');

            sel1.innerHTML = '<option value="">Choisir Équipe 1</option>';
            sel2.innerHTML = '<option value="">Choisir Équipe 2</option>';

            teams.forEach(t => {
                sel1.innerHTML += `<option value="${t.name}">${t.name}</option>`;
                sel2.innerHTML += `<option value="${t.name}">${t.name}</option>`;
            });
        }

        document.getElementById('matchForm').onsubmit = function (e) {
            e.preventDefault();
            const t1 = document.getElementById('matchTeam1').value;
            const t2 = document.getElementById('matchTeam2').value;

            if (t1 === t2) {
                alert("Veuillez choisir deux équipes différentes.");
                return;
            }

            const matchData = {
                categoryId: document.getElementById('matchCatSelect').value,
                date: document.getElementById('matchDate').value,
                time: document.getElementById('matchTime').value,
                teams: `${t1} vs ${t2}`,
                venue: document.getElementById('matchVenue').value
            };

            if (editingMatchId) {
                updateMatch(editingMatchId, matchData);
                editingMatchId = null;
                document.querySelector('#matchForm .btn-primary').innerText = "Programmer";
            } else {
                addMatch(matchData);
            }

            this.reset();
            renderMatches();
            updateMatchTeams(); // Refresh dropdowns
        };

        function handleDeleteMatch(id) {
            if (confirm('Supprimer ce match ?')) {
                deleteMatch(id);
                renderMatches();
            }
        }

        // --- NEWS ---
        function renderNews() {
            const data = getData();
            const tbody = document.getElementById('newsTableBody');
            tbody.innerHTML = '';

            if (!data.news) data.news = [];

            data.news.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(n => {
                const date = new Date(n.date).toLocaleDateString();
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${date}</td>
                    <td><strong>${n.title}</strong></td>
                    <td style="font-size: 0.8rem; max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${n.summary}</td>
                    <td>
                        <button class="btn_action btn_edit" onclick="handleEditNews(${n.id})"><i class='bx bx-edit'></i></button>
                        <button class="btn_action btn_delete" onclick="handleDeleteNews(${n.id})"><i class='bx bx-trash'></i></button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        let editingNewsId = null;
        let currentNewsLogoBase64 = 'images/hero_bg.jpg';

        function previewNewsLogo(input) {
            const preview = document.getElementById('newsLogoPreview');
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = function (e) {
                    currentNewsLogoBase64 = e.target.result;
                    preview.innerHTML = `<img src="${currentNewsLogoBase64}" style="width: 100%; height: 100%; object-fit: cover;">`;
                }
                reader.readAsDataURL(input.files[0]);
            }
        }

        function handleEditNews(id) {
            const data = getData();
            const n = data.news.find(item => item.id === id);
            if (!n) return;

            editingNewsId = id;
            document.getElementById('newsTitle').value = n.title;
            document.getElementById('newsSummary').value = n.summary;
            document.getElementById('newsContent').value = n.content;

            currentNewsLogoBase64 = n.image || 'images/hero_bg.jpg';
            document.getElementById('newsLogoPreview').innerHTML = `<img src="${currentNewsLogoBase64}" style="width: 100%; height: 100%; object-fit: cover;">`;

            document.querySelector('#newsForm .btn-primary').innerText = "Mettre à jour";
            document.getElementById('newsForm').scrollIntoView({ behavior: 'smooth' });
        }

        document.getElementById('newsForm').onsubmit = function (e) {
            e.preventDefault();
            const title = document.getElementById('newsTitle').value;
            const summary = document.getElementById('newsSummary').value;
            const content = document.getElementById('newsContent').value;
            const image = currentNewsLogoBase64;

            if (editingNewsId) {
                updateNews(editingNewsId, { title, summary, content, image });
                editingNewsId = null;
                document.querySelector('#newsForm .btn-primary').innerText = "Publier l'article";
            } else {
                addNews(title, summary, content, image);
            }

            this.reset();
            currentNewsLogoBase64 = 'images/hero_bg.jpg';
            document.getElementById('newsLogoPreview').innerHTML = `<i class='bx bx-image' style="opacity: 0.3;"></i>`;
            renderNews();
        };

        function handleDeleteNews(id) {
            if (confirm('Supprimer cet article ?')) {
                deleteNews(id);
                renderNews();
            }
        }

        // --- DRAWS ---
        function renderDraws() {
            const data = getData();
            const grid = document.getElementById('drawGrid');
            grid.innerHTML = '';

            data.categories.forEach(c => {
                const box = document.createElement('div');
                box.className = 'draw_box';
                box.style.marginTop = '0';
                box.innerHTML = `
                    <div class="trophy_icon"><i class='bx bxs-dice-6'></i></div>
                    <h3>Tirage ${c.name}</h3>
                    <p style="font-size: 0.9rem; opacity: 0.8; margin-bottom: 20px;">
                        Générer un calendrier aléatoire pour les équipes de cette catégorie.
                    </p>
                    <button class="draw_btn" onclick="runCategoryDraw('${c.id}')">LANCER</button>
                    <div id="status-${c.id}" style="margin-top: 15px; font-size: 0.8rem; color: var(--jaune-or);"></div>
                `;
                grid.appendChild(box);
            });
        }

        function runCategoryDraw(catId) {
            const status = document.getElementById(`status-${catId}`);
            status.innerText = 'Shuffle en cours...';

            setTimeout(() => {
                const data = getData();
                const teams = data.teams.filter(t => t.categoryId === catId);

                if (teams.length < 2) {
                    status.innerText = 'Erreur: Trop peu d\'équipes.';
                    return;
                }

                // Just a mock of drawing (shuffle teams) - in real use, maybe reset points?
                teams.forEach(t => updateTeam(t.id, { points: 0, v: 0, n: 0, d: 0, bp: 0, bc: 0, diff: 0 }));

                status.innerText = `Tirage terminé pour ${teams.length} équipes !`;
            }, 800);
        }

        function resetAllData() {
            if (confirm('Réinitialiser toutes les données ?')) {
                localStorage.removeItem('ligue_pro_academies_data');
                location.reload();
            }
        }

        // --- DATA EXPORT/IMPORT ---
        function exportData() {
            const data = getData();
            const dataStr = JSON.stringify(data, null, 4);
            const blob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(blob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `ligue_data_${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
        }

        function importData(input) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = async function (e) {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.categories && json.teams) {
                            if (confirm("Voulez-vous écraser vos données actuelles par celles du fichier ?")) {
                                await saveData(json);
                                alert("Données importées avec succès !");
                                location.reload();
                            }
                        } else {
                            alert("Format de fichier invalide.");
                        }
                    } catch (err) {
                        alert("Erreur lors de la lecture du fichier.");
                    }
                };
                reader.readAsText(input.files[0]);
            }
        }

        // --- SUPABASE CONFIG ---
        function loadSupabaseConfig() {
            const config = JSON.parse(localStorage.getItem('ligue_supabase_config'));
            if (config) {
                document.getElementById('supabaseUrl').value = config.url || '';
                document.getElementById('supabaseKey').value = config.key || '';
                if (config.url && config.key) {
                    document.getElementById('supabaseStatus').innerText = "✓ Sync Cloud configurée localement.";
                }
            }
        }

        async function saveSupabaseConfig() {
            const urlInput = document.getElementById('supabaseUrl');
            const keyInput = document.getElementById('supabaseKey');
            const status = document.getElementById('supabaseStatus');

            const url = urlInput.value.trim();
            const key = keyInput.value.trim();

            if (!url || !key) {
                alert("Veuillez remplir l'URL et la clé.");
                return;
            }

            status.innerHTML = "<i class='bx bx-loader-alt bx-spin'></i> Tentative de connexion...";

            try {
                // 1. Sauvegarde locale immédiate
                const config = { url, key };
                localStorage.setItem('ligue_supabase_config', JSON.stringify(config));

                // 2. Test de connexion direct
                const lib = window.supabase || (window.supabaseJS ? window.supabaseJS : null);
                if (!lib) {
                    throw new Error("La bibliothèque Supabase n'est pas chargée. Vérifiez votre connexion internet.");
                }

                let testClient;
                if (lib.createClient) {
                    testClient = lib.createClient(url, key);
                } else if (typeof lib === 'function') {
                    testClient = lib(url, key);
                } else {
                    throw new Error("La bibliothèque Supabase ne contient pas la fonction 'createClient'.");
                }

                // On tente de lire la table
                const { data, error } = await testClient.from('app_state').select('id').eq('id', 'global_state').single();

                if (error && error.code !== 'PGRST116') {
                    throw error;
                }

                // 3. Si on arrive ici, le client fonctionne. On initialise le global.
                supabaseClient = testClient;

                // 4. Test d'écriture
                await saveData(getData());

                status.innerHTML = "<b style='color: #10b981;'>✓ [V3] Connecté et synchronisé !</b>";
                alert("SUCCÈS : Supabase est bien configuré et vos données sont synchronisées !");
                location.reload();

            } catch (e) {
                console.error("DEBUG SYNC ERROR:", e);
                const errorMsg = e.message || "Erreur inconnue";
                status.innerHTML = "<b style='color: #ef4444;'>❌ Erreur : " + errorMsg + "</b>";

                let details = "DÉTAIL DE L'ERREUR :\n\n" + errorMsg;
                if (errorMsg.includes("Failed to fetch")) {
                    details += "\n\nConseil : Vérifiez votre connexion internet ou si un bloqueur désactive l'accès à Supabase.";
                } else if (errorMsg.includes("relation \"public.app_state\" does not exist")) {
                    details += "\n\nConseil : Vous n'avez pas créé la table 'app_state' dans le SQL Editor de Supabase.";
                }

                alert(details);
            }
        }

        // INIT
        initData().then(() => {
            renderCategories();
            loadSupabaseConfig();
        });

        // RE-ADD testSupabaseDirect (moved from head for cleaner auth check)
        async function testSupabaseDirect() {
            const status = document.getElementById('supabaseStatus');
            status.innerHTML = "Test en cours...";

            try {
                const url = "https://auidasirnsigninmrsdu.supabase.co";
                const key = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImF1aWRhc2lybnNpZ25pbm1yc2R1Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3ODkyNjUsImV4cCI6MjA4NTM2NTI2NX0.eFdqr5zqn-3ncVBV4YgTzgDnsjKCgwBV7zowtKm51Bw";

                const lib = window.supabase || (window.supabaseJS ? window.supabaseJS : null);

                if (!lib) {
                    alert("ERREUR : La bibliothèque Supabase n'est pas chargée.");
                    return;
                }

                let testClient;
                if (lib.createClient) {
                    testClient = lib.createClient(url, key);
                } else if (typeof lib === 'function') {
                    testClient = lib(url, key);
                } else {
                    throw new Error("Format de bibliothèque Supabase inconnu");
                }

                const { data, error } = await testClient.from('app_state').select('id').limit(1);
                if (error) throw error;
                alert("SUCCÈS : Connexion établie !");
                status.innerHTML = "<b style='color: #10b981;'>✓ Connexion Directe Réussie</b>";
            } catch (e) {
                alert("ERREUR DIRECTE : " + e.message);
                status.innerHTML = "<b style='color: #ef4444;'>❌ Echec</b>";
            }
        }
    </script>
</body>

</html>